<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitaiair 安装程序</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background-color: #0078D4;
            color: #333;
            overflow: hidden;
            height: 100vh;
            transition: background-color 0.3s;
        }

        /* 桌面背景 */
        .desktop {
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            position: relative;
            overflow: hidden;
        }

        /* 桌面图标 */
        .app-icon {
            position: absolute;
            width: 80px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            bottom: 20px;
            left: 20px;
            z-index: 1;
            opacity: 0.5;
            pointer-events: none;
        }

        .app-icon.active {
            opacity: 1;
            pointer-events: auto;
        }

        .app-icon:hover {
            transform: scale(1.1);
        }

        .app-icon i {
            font-size: 40px;
            margin-bottom: 5px;
            color: #4CAF50;
        }

        .app-icon span {
            font-size: 14px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Windows风格窗口 */
        .window {
            position: absolute;
            width: 600px;
            min-height: 500px;
            background-color: #f0f0f0;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .window-header {
            background: linear-gradient(to right, #005AA3, #0078D4);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
        }

        .window-title {
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .window-title i {
            margin-right: 8px;
        }

        .window-controls {
            display: flex;
        }

        .window-btn {
            width: 30px;
            height: 25px;
            background: transparent;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            margin-left: 5px;
        }

        .window-btn.close:hover {
            background-color: #E81123;
        }

        .window-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        /* 安装步骤样式 */
        .step {
            display: none;
            animation: fadeIn 0.5s;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .step-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #0078D4;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .step-description {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #555;
        }

        /* 配置文件样式 */
        .key-display {
            background-color: #333;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            word-break: break-all;
            font-size: 16px;
            border: 1px solid #555;
        }

        .config-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            background-color: #0078D4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #005A9E;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* 字体导入样式 */
        .font-import {
            border: 2px dashed #0078D4;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .font-import:hover {
            background-color: rgba(0, 120, 212, 0.05);
        }

        .font-preview {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 100px;
            background-color: white;
        }

        /* 主题选择器 */
        .theme-selector {
            display: flex;
            gap: 20px;
            margin: 25px 0;
        }

        .theme-option {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-option:hover {
            border-color: #0078D4;
        }

        .theme-option.selected {
            border-color: #0078D4;
            background-color: rgba(0, 120, 212, 0.05);
        }

        .theme-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* 用户注册表单 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        /* 聊天应用样式 */
        .chat-app {
            position: absolute;
            width: 500px;
            height: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 1001;
            top: 100px;
            left: 100px;
        }

        .chat-header {
            background: linear-gradient(to right, #4CAF50, #2E7D32);
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .received {
            background-color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .sent {
            background-color: #4CAF50;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .chat-footer {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
        }

        .chat-send {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 18px;
        }

        /* 用户列表样式 */
        .user-list {
            position: absolute;
            width: 200px;
            height: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 1001;
            top: 100px;
            right: 50px;
        }

        .user-list-header {
            background: linear-gradient(to right, #2196F3, #0D47A1);
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-list-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }

        .user-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-item:hover {
            background-color: #e8f5e8;
        }

        .user-item i {
            margin-right: 10px;
            color: #4CAF50;
        }

        /* 安装进度条 */
        .progress-container {
            margin: 25px 0;
        }

        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.5s;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .step-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }

        .step-dot.active {
            background-color: #0078D4;
            color: white;
        }

        /* 全屏样式 */
        body.fullscreen {
            background-color: #1e5799;
        }

        .fullscreen-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }

        /* 深色主题 */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode .window {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        body.dark-mode .window-header {
            background: linear-gradient(to right, #0d2942, #003366);
        }

        body.dark-mode .step-title {
            color: #66b0ff;
        }

        body.dark-mode .step-description {
            color: #b0b0b0;
        }

        body.dark-mode .key-display {
            background-color: #000;
            color: #0f0;
        }

        body.dark-mode .font-preview {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-color: #444;
        }

        body.dark-mode .chat-app {
            background-color: #252525;
            color: #e0e0e0;
        }

        body.dark-mode .chat-body {
            background-color: #1a1a1a;
        }

        body.dark-mode .chat-message.received {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .chat-input {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-color: #444;
        }

        body.dark-mode .user-list {
            background-color: #252525;
            color: #e0e0e0;
        }

        body.dark-mode .user-list-body {
            background-color: #1a1a1a;
        }

        body.dark-mode .user-item {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .user-item:hover {
            background-color: #3d3d3d;
        }

        /* 响应式设计 */
        @media (max-width: 650px) {
            .window {
                width: 95%;
                min-height: 400px;
            }
            
            .theme-selector {
                flex-direction: column;
            }
            
            .config-actions {
                flex-direction: column;
            }
            
            .chat-app {
                width: 95%;
                height: 80%;
                top: 10%;
                left: 2.5%;
            }
            
            .user-list {
                width: 95%;
                height: 300px;
                top: auto;
                bottom: 10%;
                right: 2.5%;
            }
        }
    </style>
</head>
<body>
    <div class="desktop">
        <!-- 桌面应用图标 -->
        <div class="app-icon" id="app-icon">
            <i class="fas fa-comments"></i>
            <span>Mitaiair</span>
        </div>

        <!-- 聊天应用窗口 (初始隐藏) -->
        <div class="chat-app" id="chat-app">
            <div class="chat-header" id="chat-header">
                <h3><i class="fas fa-comments"></i> Mitaiair 聊天</h3>
                <button class="window-btn close" id="close-chat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-body" id="chat-body">
                <div class="chat-message received" id="welcome-message">
                    <strong>系统:</strong> 欢迎使用 Mitaiair！正在扫描局域网...
                </div>
            </div>
            <div class="chat-footer">
                <input type="text" class="chat-input" id="message-input" placeholder="输入消息...">
                <button class="chat-send" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- 用户列表窗口 (初始隐藏) -->
        <div class="user-list" id="user-list">
            <div class="user-list-header">
                <h3><i class="fas fa-users"></i> 在线用户</h3>
                <button class="window-btn close" id="close-user-list">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="user-list-body" id="user-list-body">
                <!-- 用户列表将在这里动态生成 -->
                <div class="user-item" id="no-users">
                    <i class="fas fa-user-slash"></i>
                    <span>未发现其他用户</span>
                </div>
            </div>
        </div>

        <!-- 安装程序窗口 -->
        <div class="window" id="install-window">
            <div class="window-header" id="window-header">
                <div class="window-title">
                    <i class="fas fa-cogs"></i> Mitaiair 安装程序
                </div>
                <div class="window-controls">
                    <button class="window-btn close" id="close-window">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="window-content">
                <!-- 步骤1: 欢迎 -->
                <div class="step active" id="step1">
                    <h2 class="step-title">欢迎使用 Mitaiair 安装向导</h2>
                    <p class="step-description">
                        此向导将引导您完成 Mitaiair 的安装过程。Mitaiair 是一个基于局域网的即时通讯应用，允许您与同一网络内的其他用户安全聊天。
                    </p>
                    <p class="step-description">
                        Mitaiair 使用 WebSocket 技术在局域网内建立直接连接，无需中央服务器。
                    </p>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress" id="progress-bar" style="width: 16%"></div>
                        </div>
                        <div class="step-indicator">
                            <div class="step-dot active">1</div>
                            <div class="step-dot">2</div>
                            <div class="step-dot">3</div>
                            <div class="step-dot">4</div>
                            <div class="step-dot">5</div>
                            <div class="step-dot">6</div>
                        </div>
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button class="btn" id="next-step1">下一步 <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- 步骤2: 配置文件 -->
                <div class="step" id="step2">
                    <h2 class="step-title">配置文件</h2>
                    <p class="step-description">
                        Mitaiair 需要一个配置文件来运行。该文件包含一个28位的安全密钥，用于加密您的通信。
                    </p>
                    
                    <div class="key-display" id="key-display">
                        正在生成密钥...
                    </div>
                    
                    <p class="step-description">
                        默认密钥已经生成并编码。您可以使用默认密钥，也可以下载配置文件进行自定义。
                    </p>
                    
                    <div class="config-actions">
                        <button class="btn" id="download-key">
                            <i class="fas fa-download"></i> 下载配置文件 (key.mitaiair)
                        </button>
                        <button class="btn" id="use-default-key">
                            <i class="fas fa-check"></i> 使用默认密钥
                        </button>
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button class="btn btn-secondary" id="prev-step2"><i class="fas fa-arrow-left"></i> 上一步</button>
                        <button class="btn" id="next-step2">下一步 <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- 步骤3: 字体选择 -->
                <div class="step" id="step3">
                    <h2 class="step-title">自定义字体</h2>
                    <p class="step-description">
                        您可以选择自定义字体以个性化您的 Mitaiair 界面。支持 TTF 字体格式。
                    </p>
                    
                    <div class="font-import" id="font-drop-area">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #0078D4; margin-bottom: 15px;"></i>
                        <h3>拖放字体文件到这里</h3>
                        <p>或点击选择 TTF 字体文件</p>
                        <input type="file" id="font-file" accept=".ttf" style="display: none;">
                    </div>
                    
                    <div class="font-preview" id="font-preview">
                        <h4>字体预览:</h4>
                        <p style="font-size: 20px; margin-top: 10px;">
                            这是一段示例文本，展示所选字体的外观。
                            ABCDEFGHIJKLMNOPQRSTUVWXYZ<br>
                            abcdefghijklmnopqrstuvwxyz<br>
                            1234567890
                        </p>
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button class="btn btn-secondary" id="prev-step3"><i class="fas fa-arrow-left"></i> 上一步</button>
                        <button class="btn" id="next-step3">下一步 <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- 步骤4: 主题选择 -->
                <div class="step" id="step4">
                    <h2 class="step-title">选择主题</h2>
                    <p class="step-description">
                        选择您喜欢的界面主题。您可以在安装后随时更改此设置。
                    </p>
                    
                    <div class="theme-selector">
                        <div class="theme-option" id="light-theme">
                            <div class="theme-icon">
                                <i class="fas fa-sun"></i>
                            </div>
                            <h3>浅色模式</h3>
                            <p>明亮清晰的界面</p>
                        </div>
                        <div class="theme-option selected" id="dark-theme">
                            <div class="theme-icon">
                                <i class="fas fa-moon"></i>
                            </div>
                            <h3>深色模式</h3>
                            <p>保护眼睛，节省电量</p>
                        </div>
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button class="btn btn-secondary" id="prev-step4"><i class="fas fa-arrow-left"></i> 上一步</button>
                        <button class="btn" id="next-step4">下一步 <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- 步骤5: 用户创建 -->
                <div class="step" id="step5">
                    <h2 class="step-title">创建用户账户</h2>
                    <p class="step-description">
                        创建您的 Mitaiair 用户账户。此信息将用于在局域网内标识您的身份。
                    </p>
                    
                    <div class="form-group">
                        <label for="username">用户名:</label>
                        <input type="text" id="username" placeholder="输入用户名">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">密码:</label>
                        <input type="password" id="password" placeholder="输入密码">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-password">确认密码:</label>
                        <input type="password" id="confirm-password" placeholder="再次输入密码">
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button class="btn btn-secondary" id="prev-step5"><i class="fas fa-arrow-left"></i> 上一步</button>
                        <button class="btn" id="next-step5">下一步 <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- 步骤6: 完成安装 -->
                <div class="step" id="step6">
                    <h2 class="step-title">安装完成</h2>
                    <div style="text-align: center; margin: 40px 0;">
                        <i class="fas fa-check-circle" style="font-size: 80px; color: #4CAF50; margin-bottom: 20px;"></i>
                        <h3>Mitaiair 安装成功！</h3>
                        <p class="step-description">
                            您现在可以开始使用 Mitaiair。点击桌面上的 Mitaiair 图标启动应用程序。
                        </p>
                        <p class="step-description">
                            Mitaiair 将自动扫描局域网内其他用户，您可以在用户列表中查看在线用户并开始聊天。
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" id="finish-install">
                            <i class="fas fa-rocket"></i> 启动 Mitaiair
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="fullscreen-btn" id="fullscreen-btn">
        <i class="fas fa-expand"></i> 全屏
    </button>

    <script>
        // 全局变量
        let currentStep = 1;
        let selectedTheme = 'dark-mode';
        let customFont = null;
        let userName = '';
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let chatDragging = false;
        let chatDragOffset = { x: 0, y: 0 };
        let userListDragging = false;
        let userListDragOffset = { x: 0, y: 0 };
        
        // 模拟的WebSocket连接（在实际应用中，这里应该是真实的WebSocket连接）
        let mockWebSocket = {
            connected: false,
            connect: function() {
                this.connected = true;
                console.log("模拟WebSocket连接已建立");
                // 在实际应用中，这里应该连接到真实的WebSocket服务器
                return true;
            },
            send: function(message) {
                console.log("模拟发送消息:", message);
                // 在实际应用中，这里应该通过WebSocket发送消息
                return true;
            },
            disconnect: function() {
                this.connected = false;
                console.log("模拟WebSocket连接已断开");
            }
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 生成密钥并显示
            generateAndDisplayKey();
            
            // 初始化全屏功能
            initFullscreen();
            
            // 初始化窗口拖动功能
            initWindowDrag();
            initChatDrag();
            initUserListDrag();
            
            // 绑定事件监听器
            bindEvents();
            
            // 自动尝试全屏（可能需要用户交互）
            setTimeout(tryAutoFullscreen, 500);
        });
        
        // 生成并显示密钥
        function generateAndDisplayKey() {
            const defaultKey = "m1i2t3a4i5a6i7r123";
            
            // Base64编码
            const base64Key = btoa(defaultKey);
            
            // 向后移3位
            let shiftedKey = '';
            for (let i = 0; i < base64Key.length; i++) {
                let charCode = base64Key.charCodeAt(i);
                // 只处理字母和数字
                if ((charCode >= 65 && charCode <= 90) || // A-Z
                    (charCode >= 97 && charCode <= 122) || // a-z
                    (charCode >= 48 && charCode <= 57)) { // 0-9
                    shiftedKey += String.fromCharCode(charCode + 3);
                } else {
                    shiftedKey += base64Key[i];
                }
            }
            
            document.getElementById('key-display').textContent = shiftedKey;
        }
        
        // 初始化全屏功能
        function initFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            fullscreenBtn.addEventListener('click', function() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log(`全屏请求失败: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });
            
            // 监听全屏变化
            document.addEventListener('fullscreenchange', function() {
                if (document.fullscreenElement) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> 退出全屏';
                } else {
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> 全屏';
                }
            });
        }
        
        // 尝试自动全屏
        function tryAutoFullscreen() {
            // 创建一个透明的覆盖层，用户点击后触发全屏
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
            overlay.style.color = 'white';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '10000';
            overlay.innerHTML = `
                <h2 style="margin-bottom: 20px;">Mitaiair 安装程序</h2>
                <p style="margin-bottom: 30px; text-align: center; max-width: 80%;">点击任意位置进入全屏模式以获得最佳安装体验</p>
                <button style="padding: 12px 24px; background-color: #0078D4; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                    进入全屏模式
                </button>
            `;
            
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', function() {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`全屏请求失败: ${err.message}`);
                });
                document.body.removeChild(overlay);
            });
        }
        
        // 初始化窗口拖动
        function initWindowDrag() {
            const windowElement = document.getElementById('install-window');
            const header = document.getElementById('window-header');
            
            header.addEventListener('mousedown', startDrag.bind(null, windowElement));
            document.addEventListener('mousemove', drag.bind(null, windowElement));
            document.addEventListener('mouseup', stopDrag);
            
            // 触摸设备支持
            header.addEventListener('touchstart', startDragTouch.bind(null, windowElement));
            document.addEventListener('touchmove', dragTouch.bind(null, windowElement));
            document.addEventListener('touchend', stopDrag);
        }
        
        // 初始化聊天窗口拖动
        function initChatDrag() {
            const chatWindow = document.getElementById('chat-app');
            const chatHeader = document.getElementById('chat-header');
            
            chatHeader.addEventListener('mousedown', startChatDrag.bind(null, chatWindow));
            document.addEventListener('mousemove', dragChat.bind(null, chatWindow));
            document.addEventListener('mouseup', stopChatDrag);
            
            // 触摸设备支持
            chatHeader.addEventListener('touchstart', startChatDragTouch.bind(null, chatWindow));
            document.addEventListener('touchmove', dragChatTouch.bind(null, chatWindow));
            document.addEventListener('touchend', stopChatDrag);
        }
        
        // 初始化用户列表窗口拖动
        function initUserListDrag() {
            const userListWindow = document.getElementById('user-list');
            const userListHeader = document.querySelector('.user-list-header');
            
            userListHeader.addEventListener('mousedown', startUserListDrag.bind(null, userListWindow));
            document.addEventListener('mousemove', dragUserList.bind(null, userListWindow));
            document.addEventListener('mouseup', stopUserListDrag);
            
            // 触摸设备支持
            userListHeader.addEventListener('touchstart', startUserListDragTouch.bind(null, userListWindow));
            document.addEventListener('touchmove', dragUserListTouch.bind(null, userListWindow));
            document.addEventListener('touchend', stopUserListDrag);
        }
        
        // 鼠标拖拽开始
        function startDrag(windowElement, e) {
            e.preventDefault();
            isDragging = true;
            
            const rect = windowElement.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            // 移除居中样式，改为绝对定位
            windowElement.style.transform = 'none';
            windowElement.style.transition = 'none';
        }
        
        // 鼠标拖拽
        function drag(windowElement, e) {
            if (!isDragging) return;
            e.preventDefault();
            
            let x = e.clientX - dragOffset.x;
            let y = e.clientY - dragOffset.y;
            
            // 限制窗口在视口内
            const maxX = window.innerWidth - windowElement.offsetWidth;
            const maxY = window.innerHeight - windowElement.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            windowElement.style.left = x + 'px';
            windowElement.style.top = y + 'px';
        }
        
        // 鼠标拖拽结束
        function stopDrag() {
            isDragging = false;
        }
        
        // 触摸拖拽开始
        function startDragTouch(windowElement, e) {
            if (e.touches.length !== 1) return;
            e.preventDefault();
            isDragging = true;
            
            const rect = windowElement.getBoundingClientRect();
            dragOffset.x = e.touches[0].clientX - rect.left;
            dragOffset.y = e.touches[0].clientY - rect.top;
            
            // 移除居中样式，改为绝对定位
            windowElement.style.transform = 'none';
            windowElement.style.transition = 'none';
        }
        
        // 触摸拖拽
        function dragTouch(windowElement, e) {
            if (!isDragging || e.touches.length !== 1) return;
            e.preventDefault();
            
            let x = e.touches[0].clientX - dragOffset.x;
            let y = e.touches[0].clientY - dragOffset.y;
            
            // 限制窗口在视口内
            const maxX = window.innerWidth - windowElement.offsetWidth;
            const maxY = window.innerHeight - windowElement.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            windowElement.style.left = x + 'px';
            windowElement.style.top = y + 'px';
        }
        
        // 聊天窗口拖拽开始
        function startChatDrag(chatWindow, e) {
            e.preventDefault();
            chatDragging = true;
            
            const rect = chatWindow.getBoundingClientRect();
            chatDragOffset.x = e.clientX - rect.left;
            chatDragOffset.y = e.clientY - rect.top;
        }
        
        // 聊天窗口拖拽
        function dragChat(chatWindow, e) {
            if (!chatDragging) return;
            e.preventDefault();
            
            let x = e.clientX - chatDragOffset.x;
            let y = e.clientY - chatDragOffset.y;
            
            // 限制窗口在视口内
            const maxX = window.innerWidth - chatWindow.offsetWidth;
            const maxY = window.innerHeight - chatWindow.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            chatWindow.style.left = x + 'px';
            chatWindow.style.top = y + 'px';
        }
        
        // 聊天窗口拖拽结束
        function stopChatDrag() {
            chatDragging = false;
        }
        
        // 聊天窗口触摸拖拽开始
        function startChatDragTouch(chatWindow, e) {
            if (e.touches.length !== 1) return;
            e.preventDefault();
            chatDragging = true;
            
            const rect = chatWindow.getBoundingClientRect();
            chatDragOffset.x = e.touches[0].clientX - rect.left;
            chatDragOffset.y = e.touches[0].clientY - rect.top;
        }
        
        // 聊天窗口触摸拖拽
        function dragChatTouch(chatWindow, e) {
            if (!chatDragging || e.touches.length !== 1) return;
            e.preventDefault();
            
            let x = e.touches[0].clientX - chatDragOffset.x;
            let y = e.touches[0].clientY - chatDragOffset.y;
            
            // 限制窗口在视口内
            const maxX = window.innerWidth - chatWindow.offsetWidth;
            const maxY = window.innerHeight - chatWindow.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            chatWindow.style.left = x + 'px';
            chatWindow.style.top = y + 'px';
        }
        
        // 用户列表窗口拖拽开始
        function startUserListDrag(userListWindow, e) {
            e.preventDefault();
            userListDragging = true;
            
            const rect = userListWindow.getBoundingClientRect();
            userListDragOffset.x = e.clientX - rect.left;
            userListDragOffset.y = e.clientY - rect.top;
        }
        
        // 用户列表窗口拖拽
        function dragUserList(userListWindow, e) {
            if (!userListDragging) return;
            e.preventDefault();
            
            let x = e.clientX - userListDragOffset.x;
            let y = e.clientY - userListDragOffset.y;
            
            // 限制窗口在视口内
            const maxX = window.innerWidth - userListWindow.offsetWidth;
            const maxY = window.innerHeight - userListWindow.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            userListWindow.style.left = x + 'px';
            userListWindow.style.top = y + 'px';
        }
        
        // 用户列表窗口拖拽结束
        function stopUserListDrag() {
            userListDragging = false;
        }
        
        // 用户列表窗口触摸拖拽开始
        function startUserListDragTouch(userListWindow, e) {
            if (e.touches.length !== 1) return;
            e.preventDefault();
            userListDragging = true;
            
            const rect = userListWindow.getBoundingClientRect();
            userListDragOffset.x = e.touches[0].clientX - rect.left;
            userListDragOffset.y = e.touches[0].clientY - rect.top;
        }
        
        // 用户列表窗口触摸拖拽
        function dragUserListTouch(userListWindow, e) {
            if (!userListDragging || e.touches.length !== 1) return;
            e.preventDefault();
            
            let x = e.touches[0].clientX - userListDragOffset.x;
            let y = e.touches[0].clientY - userListDragOffset.y;
            
            // 限制窗口在视口内
            const maxX = window.innerWidth - userListWindow.offsetWidth;
            const maxY = window.innerHeight - userListWindow.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            userListWindow.style.left = x + 'px';
            userListWindow.style.top = y + 'px';
        }
        
        // 绑定所有事件监听器
        function bindEvents() {
            // 关闭窗口按钮
            document.getElementById('close-window').addEventListener('click', function() {
                if (confirm('您确定要取消安装吗？')) {
                    document.getElementById('install-window').style.display = 'none';
                }
            });
            
            // 关闭聊天窗口按钮
            document.getElementById('close-chat').addEventListener('click', function() {
                document.getElementById('chat-app').style.display = 'none';
            });
            
            // 关闭用户列表窗口按钮
            document.getElementById('close-user-list').addEventListener('click', function() {
                document.getElementById('user-list').style.display = 'none';
            });
            
            // 下一步/上一步按钮
            document.getElementById('next-step1').addEventListener('click', () => changeStep(2));
            document.getElementById('prev-step2').addEventListener('click', () => changeStep(1));
            document.getElementById('next-step2').addEventListener('click', () => changeStep(3));
            document.getElementById('prev-step3').addEventListener('click', () => changeStep(2));
            document.getElementById('next-step3').addEventListener('click', () => changeStep(4));
            document.getElementById('prev-step4').addEventListener('click', () => changeStep(3));
            document.getElementById('next-step4').addEventListener('click', () => changeStep(5));
            document.getElementById('prev-step5').addEventListener('click', () => changeStep(4));
            document.getElementById('next-step5').addEventListener('click', () => {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // 静默验证，不显示任何提示
                if (!username || !password || !confirmPassword) {
                    return;
                }
                
                if (password !== confirmPassword) {
                    return;
                }
                
                if (password.length < 6) {
                    return;
                }
                
                if (username.length < 3) {
                    return;
                }
                
                userName = username;
                changeStep(6);
            });
            
            // 下载配置文件
            document.getElementById('download-key').addEventListener('click', downloadConfigFile);
            
            // 使用默认密钥
            document.getElementById('use-default-key').addEventListener('click', function() {
                changeStep(3);
            });
            
            // 字体导入
            const fontDropArea = document.getElementById('font-drop-area');
            const fontFileInput = document.getElementById('font-file');
            
            fontDropArea.addEventListener('click', function() {
                fontFileInput.click();
            });
            
            fontFileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (file.type === 'font/ttf' || file.name.endsWith('.ttf')) {
                        const fontUrl = URL.createObjectURL(file);
                        customFont = file.name.replace('.ttf', '');
                        
                        // 创建字体Face
                        const fontFace = new FontFace(customFont, `url(${fontUrl})`);
                        
                        fontFace.load().then(function(loadedFont) {
                            document.fonts.add(loadedFont);
                            document.getElementById('font-preview').style.fontFamily = `'${customFont}', sans-serif`;
                        }).catch(function(error) {
                            console.log('字体加载失败: ' + error.message);
                        });
                    }
                }
            });
            
            // 拖放字体文件
            fontDropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                fontDropArea.style.backgroundColor = 'rgba(0, 120, 212, 0.1)';
            });
            
            fontDropArea.addEventListener('dragleave', function() {
                fontDropArea.style.backgroundColor = '';
            });
            
            fontDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                fontDropArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.type === 'font/ttf' || file.name.endsWith('.ttf')) {
                        // 模拟文件输入
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fontFileInput.files = dataTransfer.files;
                        
                        // 触发change事件
                        fontFileInput.dispatchEvent(new Event('change'));
                    }
                }
            });
            
            // 主题选择
            document.getElementById('light-theme').addEventListener('click', function() {
                selectTheme('light');
            });
            
            document.getElementById('dark-theme').addEventListener('click', function() {
                selectTheme('dark');
            });
            
            // 完成安装按钮
            document.getElementById('finish-install').addEventListener('click', finishInstallation);
            
            // 桌面应用图标点击
            document.getElementById('app-icon').addEventListener('click', function() {
                // 只有安装完成后才能点击
                if (document.getElementById('app-icon').classList.contains('active')) {
                    document.getElementById('chat-app').style.display = 'flex';
                    document.getElementById('user-list').style.display = 'flex';
                    startChatSession();
                }
            });
            
            // 发送聊天消息
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // 切换步骤
        function changeStep(step) {
            // 隐藏当前步骤
            document.querySelector(`#step${currentStep}`).classList.remove('active');
            
            // 显示新步骤
            document.querySelector(`#step${step}`).classList.add('active');
            
            // 更新进度条
            const progressPercentage = (step / 6) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
            
            // 更新步骤指示器
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                const stepNumber = index + 1;
                if (stepNumber <= step) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            
            currentStep = step;
        }
        
        // 下载配置文件
        function downloadConfigFile() {
            const keyContent = document.getElementById('key-display').textContent;
            const defaultKey = "m1i2t3a4i5a6i7r123";
            
            // 创建配置文件内容
            const configContent = `# Mitaiair 配置文件
# 此文件包含您的加密密钥

KEY=${keyContent}
DEFAULT_KEY=${defaultKey}
ENCODING=base64_shift+3
DATE=${new Date().toISOString()}`;
            
            // 创建下载链接
            const blob = new Blob([configContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'key.mitaiair';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 选择主题
        function selectTheme(theme) {
            // 更新UI选择状态
            document.getElementById('light-theme').classList.remove('selected');
            document.getElementById('dark-theme').classList.remove('selected');
            
            if (theme === 'light') {
                document.getElementById('light-theme').classList.add('selected');
                document.body.classList.remove('dark-mode');
                selectedTheme = 'light';
            } else {
                document.getElementById('dark-theme').classList.add('selected');
                document.body.classList.add('dark-mode');
                selectedTheme = 'dark-mode';
            }
        }
        
        // 完成安装
        function finishInstallation() {
            // 隐藏安装窗口
            document.getElementById('install-window').style.display = 'none';
            
            // 激活桌面图标
            document.getElementById('app-icon').classList.add('active');
            
            // 显示成功消息
            alert(`安装完成！欢迎 ${userName} 使用 Mitaiair。\n\n点击桌面上的 Mitaiair 图标开始聊天。`);
            
            // 可以在这里添加更多安装完成后的操作
            console.log('安装完成，用户:', userName, '主题:', selectedTheme, '字体:', customFont);
        }
        
        // 开始聊天会话
        function startChatSession() {
            const chatBody = document.getElementById('chat-body');
            
            // 清空之前的消息（除了欢迎消息）
            const welcomeMessage = document.getElementById('welcome-message');
            chatBody.innerHTML = '';
            if (welcomeMessage) {
                chatBody.appendChild(welcomeMessage);
            }
            
            // 更新欢迎消息
            if (welcomeMessage) {
                welcomeMessage.innerHTML = `<strong>系统:</strong> 欢迎 ${userName} 使用 Mitaiair！正在扫描局域网内的其他用户...`;
            }
            
            // 模拟连接过程
            setTimeout(() => {
                if (welcomeMessage) {
                    welcomeMessage.innerHTML = `<strong>系统:</strong> 欢迎 ${userName} 使用 Mitaiair！您已进入聊天室。`;
                }
                
                // 在实际应用中，这里应该建立WebSocket连接
                mockWebSocket.connect();
                
                // 显示用户列表
                updateUserList();
            }, 2000);
        }
        
        // 更新用户列表
        function updateUserList() {
            const userListBody = document.getElementById('user-list-body');
            
            // 清空用户列表
            userListBody.innerHTML = '';
            
            // 添加当前用户
            const currentUserItem = document.createElement('div');
            currentUserItem.className = 'user-item';
            currentUserItem.innerHTML = `<i class="fas fa-user-check"></i><span>${userName} (您)</span>`;
            userListBody.appendChild(currentUserItem);
            
            // 在实际应用中，这里应该从WebSocket服务器获取在线用户列表
            // 这里我们模拟一个空列表，表示没有发现其他用户
            
            const noUsersItem = document.createElement('div');
            noUsersItem.className = 'user-item';
            noUsersItem.id = 'no-users';
            noUsersItem.innerHTML = `<i class="fas fa-user-slash"></i><span>未发现其他用户</span>`;
            userListBody.appendChild(noUsersItem);
        }
        
        // 发送聊天消息
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (message) {
                const chatBody = document.getElementById('chat-body');
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message sent';
                messageElement.innerHTML = `<strong>${userName}:</strong> ${message}`;
                chatBody.appendChild(messageElement);
                input.value = '';
                
                // 滚动到底部
                chatBody.scrollTop = chatBody.scrollHeight;
                
                // 在实际应用中，这里应该通过WebSocket发送消息
                mockWebSocket.send({
                    type: 'message',
                    content: message,
                    sender: userName,
                    timestamp: new Date().toISOString()
                });
                
                // 模拟消息已发送的确认
                setTimeout(() => {
                    const confirmationElement = document.createElement('div');
                    confirmationElement.className = 'chat-message received';
                    confirmationElement.style.opacity = '0.7';
                    confirmationElement.style.fontSize = '12px';
                    confirmationElement.innerHTML = `<strong>系统:</strong> 消息已发送 (局域网广播)`;
                    chatBody.appendChild(confirmationElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                }, 500);
            }
        }
    </script>
</body>
</html>