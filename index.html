<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>APK 自动解析器</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --card-bg:#fff;
      --muted:#666;
      --accent:#0b79d0;
      --success:#1a8f3b;
      --danger:#d04444;
    }
    body{font-family:Inter, "Helvetica Neue", Arial, sans-serif; background:#f4f6f8; margin:0; padding:28px; display:flex; justify-content:center;}
    .container{width:100%; max-width:820px;}
    header{margin-bottom:18px;}
    h1{margin:0 0 6px 0; font-size:20px;}
    p.lead{margin:0; color:var(--muted); font-size:13px;}
    .card{background:var(--card-bg); border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(15,30,50,0.06);}
    .drop{border:2px dashed #e1e6ea; border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:background .15s, border-color .15s;}
    .drop.dragover{background:rgba(11,121,208,0.04); border-color:var(--accent);}
    .row{display:flex; gap:16px; align-items:center;}
    .col{flex:1;}
    .actions{display:flex; gap:12px; margin-top:12px;}
    button{background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer;}
    button.secondary{background:#fff; color:var(--accent); border:1px solid #dbe6f0;}
    input[type=file]{display:none;}
    .result{margin-top:16px; padding:14px; background:#fbfdff; border-radius:8px; border:1px solid #eef6ff;}
    .field{display:flex; gap:12px; align-items:center; margin-bottom:8px;}
    .label{width:160px; color:var(--muted); font-size:13px;}
    .value{font-size:14px; word-break:break-all;}
    .status{font-size:13px; color:var(--muted); margin-top:8px;}
    .progress{height:10px; background:#e9f2fb; border-radius:999px; overflow:hidden; margin-top:10px;}
    .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#0b79d0,#62b0f6);}
    .icon{width:72px; height:72px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #eef6ff; background:#fff;}
    .small-muted{color:var(--muted); font-size:12px;}
    pre.json{background:#0f1720; color:#e6eef6; padding:10px; border-radius:6px; overflow:auto; max-height:220px;}
    @media (max-width:640px){
      .row{flex-direction:column; align-items:stretch;}
      .label{width:120px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>APK 自动解析器</h1>
      <p class="lead">把 `.apk` 文件拖到下面，或点击选择上传。解析后会显示：应用名、包名、最低系统、是否支持 32/64 位。</p>
    </header>

    <div class="card">
      <div id="dropZone" class="drop" tabindex="0">
        <div style="display:flex;align-items:center;gap:14px;justify-content:center;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 3v10" stroke="#0b79d0" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 7l4-4 4 4" stroke="#0b79d0" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="13" width="18" height="8" rx="2" stroke="#0b79d0" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div style="text-align:left;">
            <div style="font-weight:600">点击选择或拖放你的 APK 文件 到此处</div>
            <div class="small-muted">仅接受 <code>.apk</code> 文件，单次上传最大受后端限制</div>
          </div>
        </div>
      </div>

      <input id="fileInput" type="file" accept=".apk" />

      <div class="actions">
        <button id="chooseBtn" class="secondary">选择文件</button>
        <button id="uploadBtn">上传并解析</button>
        <div id="filename" class="small-muted" style="align-self:center;">未选择文件</div>
      </div>

      <div id="statusArea" style="display:none; margin-top:12px;">
        <div id="statusText" class="status"></div>
        <div class="progress" style="display:none;" id="progressWrap"><i id="progressBar"></i></div>
      </div>

      <div id="result" class="result" style="display:none;">
        <div style="display:flex; gap:16px; align-items:center; margin-bottom:12px;">
          <div id="appIcon" class="icon" style="flex:0 0 72px;">
            <!-- icon goes here -->
          </div>
          <div style="flex:1;">
            <div style="font-size:16px; font-weight:700;" id="appName">—</div>
            <div class="small-muted" id="pkgName">包名: —</div>
          </div>
          <div style="text-align:right;">
            <div class="small-muted">最低系统</div>
            <div id="minSdk" style="font-weight:700;">—</div>
          </div>
        </div>

        <div class="field"><div class="label">支持 32-bit</div><div class="value" id="supports32">—</div></div>
        <div class="field"><div class="label">支持 64-bit</div><div class="value" id="supports64">—</div></div>
        <div class="field"><div class="label">lib/ 子目录</div><div class="value" id="archFolders">—</div></div>

        <details style="margin-top:12px;">
          <summary style="cursor:pointer">原始返回 JSON</summary>
          <pre class="json" id="rawJson">{ }</pre>
        </details>
      </div>
    </div>
  </div>

<script>
(function(){
  const drop = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const chooseBtn = document.getElementById('chooseBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const filenameEl = document.getElementById('filename');
  const statusArea = document.getElementById('statusArea');
  const statusText = document.getElementById('statusText');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar = document.getElementById('progressBar');
  const result = document.getElementById('result');
  const appIcon = document.getElementById('appIcon');
  const appName = document.getElementById('appName');
  const pkgName = document.getElementById('pkgName');
  const minSdkEl = document.getElementById('minSdk');
  const supports32 = document.getElementById('supports32');
  const supports64 = document.getElementById('supports64');
  const archFolders = document.getElementById('archFolders');
  const rawJson = document.getElementById('rawJson');

  let selectedFile = null;

  function setFilename(name){
    filenameEl.textContent = name || '未选择文件';
  }

  chooseBtn.addEventListener('click', ()=> fileInput.click());
  drop.addEventListener('click', ()=> fileInput.click());

  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    handleSelectedFile(f);
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation();
      drop.classList.add('dragover');
    });
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation();
      drop.classList.remove('dragover');
    });
  });
  drop.addEventListener('drop', (e)=>{
    const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    handleSelectedFile(f);
  });

  function handleSelectedFile(f){
    if(!f) return;
    if(!f.name.toLowerCase().endsWith('.apk')){
      alert('只接受 .apk 文件');
      return;
    }
    selectedFile = f;
    setFilename(f.name);
    result.style.display = 'none';
    statusArea.style.display = 'none';
  }

  uploadBtn.addEventListener('click', ()=>{
    if(!selectedFile){
      alert('请先选择一个 .apk 文件');
      return;
    }
    uploadFile(selectedFile);
  });

  function resetProgress(){
    progressBar.style.width = '0%';
    progressWrap.style.display = 'none';
  }

  function uploadFile(file){
    const form = new FormData();
    form.append('file', file);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload', true);

    statusArea.style.display = 'block';
    statusText.textContent = '上传中...';
    progressWrap.style.display = 'block';
    progressBar.style.width = '0%';

    xhr.upload.onprogress = function(e){
      if(e.lengthComputable){
        const pct = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = pct + '%';
        statusText.textContent = '上传中：' + pct + '%';
      }
    };

    xhr.onload = function(){
      statusText.textContent = '';
      progressBar.style.width = '100%';
      try {
        const code = xhr.status;
        const data = JSON.parse(xhr.responseText || '{}');
        if(code >= 200 && code < 300 && data.ok){
          displayResult(data);
          statusText.textContent = '解析完成';
        } else {
          const err = data && data.error ? data.error : ('HTTP ' + code);
          statusText.textContent = '解析失败：' + err;
          result.style.display = 'none';
        }
      } catch(err){
        statusText.textContent = '解析响应失败：' + err.message;
        result.style.display = 'none';
      }
      setTimeout(()=>{ resetProgress(); }, 700);
    };

    xhr.onerror = function(){
      statusText.textContent = '网络错误或服务器不可达';
      resetProgress();
      result.style.display = 'none';
    };

    xhr.send(form);
  }

  function displayResult(data){
    appName.textContent = data.app_name || '(未知)';
    pkgName.textContent = '包名: ' + (data.package || '(未知)');
    minSdkEl.textContent = (data.min_sdk === null || data.min_sdk === undefined) ? '(未声明)' : String(data.min_sdk);
    supports32.textContent = data.supports_32_bit ? '是' : '否';
    supports64.textContent = data.supports_64_bit ? '是' : '否';
    archFolders.textContent = (data.arch_folders && data.arch_folders.length) ? data.arch_folders.join(', ') : '(无 native libs)';

    // 如果后端返回 icon_base64（可选），展示
    if(data.icon_base64){
      const img = document.createElement('img');
      img.src = 'data:image/png;base64,' + data.icon_base64;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      appIcon.innerHTML = '';
      appIcon.appendChild(img);
    } else {
      // 采用首字母占位
      const initials = (data.app_name || '').trim().charAt(0).toUpperCase() || '?';
      appIcon.innerHTML = '<div style="font-weight:700;color:var(--accent);font-size:28px;">' + initials + '</div>';
    }

    rawJson.textContent = JSON.stringify(data, null, 2);
    result.style.display = 'block';
  }

  // keyboard accessibility: Enter to open file picker
  drop.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') fileInput.click();
  });

})();
</script>
</body>
</html>