<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>2048</title>
<style>
  :root{
    --bg: #121217;
    --panel: #1b1b20;
    --tile-bg: #232328;
    --text: #e6e6e9;
    --muted: #9aa0a6;
    --accent: #ffb259;
    --tile-size: 84px;
    --gap: 12px;
    --cursor-default-size: 28px;
    --cursor-max-size: 88px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(180deg,var(--bg),#0d0d10);
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    overflow:hidden;
  }

  /* hide native cursor when using our custom cursor */
  html.no-cursor *{ cursor: none !important; }

  .game-wrap{
    width: min(1100px,96vw);
    height: min(640px,86vh);
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .panel{
    background: linear-gradient(180deg,var(--panel), #15151a);
    border-radius:14px;
    padding:18px;
    display:flex;
    flex-direction:column;
    gap:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }

  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .title{
    font-weight:700;
    font-size:24px;
  }

  .controls{
    display:flex;
    gap:8px;
  }

  .score{
    background:#0f0f12;
    padding:8px 12px;
    border-radius:8px;
    min-width:88px;
    text-align:center;
  }
  .score .label{font-size:12px;color:var(--muted);}
  .score .value{font-size:16px;font-weight:700;}

  .btn{
    background:#2b2b30;
    border:1px solid rgba(255,255,255,0.08);
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer; /* fallback for touch devices */
    color:var(--text);
    font-weight:600;
    transition:background .12s, transform .08s;
    user-select:none;
  }
  .btn.small{padding:6px 8px;font-size:13px;}
  .btn:active{transform:scale(.98);}

  .board{
    background:#0e0e11;
    padding:var(--gap);
    border-radius:12px;
    display:grid;
    grid-template-columns:repeat(6,var(--tile-size));
    grid-template-rows:repeat(6,var(--tile-size));
    gap:var(--gap);
    position:relative;
    user-select:none;
    touch-action:none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤çš„è§¦æ‘¸æ‰‹åŠ¿ï¼ˆé˜²æ­¢æ»‘åŠ¨å¯¼è‡´é¡µé¢ç§»åŠ¨ï¼‰ */
  }
  .cell{
    width:var(--tile-size);
    height:var(--tile-size);
    border-radius:10px;
    background:var(--tile-bg);
  }

  .tile{
    position:absolute;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    color:#fff;
    font-size:20px;
    transition:transform .15s ease, left .08s linear, top .08s linear;
    will-change: transform, left, top;
  }

  .tile.v2{background:#eee4da;color:#776e65;}
  .tile.v4{background:#ede0c8;color:#776e65;}
  .tile.v8{background:#f2b179;}
  .tile.v16{background:#f59563;}
  .tile.v32{background:#f67c5f;}
  .tile.v64{background:#f65e3b;}
  .tile.v128{background:#edcf72;color:#3c2e12;}
  .tile.v256{background:#edcc61;color:#3c2e12;}
  .tile.v512{background:#edc850;color:#3c2e12;}
  .tile.v1024{background:#edc53f;color:#3c2e12;}
  .tile.v2048{background:#edc22e;color:#3c2e12;}

  .overlay{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.45);
    border-radius:12px;
    z-index:60;
  }

  .modal{
    background:#1f1f23;
    padding:18px;
    border-radius:12px;
    text-align:center;
  }

  /* ----- è‡ªå®šä¹‰å…‰æ ‡ ----- */
  #customCursor{
    position:fixed;
    left:0;
    top:0;
    width:var(--cursor-default-size);
    height:var(--cursor-default-size);
    transform:translate(-50%,-50%);
    border-radius:50%;
    pointer-events:none; /* ä¸é˜»æŒ¡é¼ æ ‡äº‹ä»¶ */
    z-index:99999;
    display:block;
    box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.14), rgba(255,255,255,0.02) 25%, rgba(255,255,255,0) 40%), rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    transition: width .12s ease, height .12s ease, border-radius .12s ease, transform .03s linear, background .12s ease, left .02s linear, top .02s linear;
    mix-blend-mode:screen;
  }
  /* æ–¹å½¢çŠ¶æ€ */
  #customCursor.square{
    border-radius:8px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  }

  /* éšè—è‡ªå®šä¹‰å…‰æ ‡åœ¨è§¦æ‘¸/ç²—æŒ‡é’ˆè®¾å¤‡ */
  html.cursor-disabled #customCursor{ display:none; }
  html.cursor-disabled *{ cursor: auto !important; }
  /* ---------------------- */

  @media (max-width:760px){
    :root{ --tile-size:56px; --gap:10px; --cursor-default-size:22px; --cursor-max-size:60px; }
    .title{ font-size:20px; }
  }
</style>
</head>
<body>
  <div class="game-wrap">
    <div class="panel">
      <div class="header">
        <div class="title">2048</div>
        <div class="controls">
          <div class="score"><div class="label">åˆ†æ•°</div><div class="value" id="score">0</div></div>
          <div class="score"><div class="label">æœ€é«˜</div><div class="value" id="best">0</div></div>
          <button class="btn small" id="newBtn">æ–°æ¸¸æˆ</button>
        </div>
      </div>
      <div class="board" id="board"></div>
      <div class="overlay" id="overlay"></div>
    </div>
  </div>

  <!-- è‡ªå®šä¹‰å…‰æ ‡å…ƒç´  -->
  <div id="customCursor" aria-hidden="true"></div>

<script>
(() => {
  /* ====== æ¸¸æˆï¼ˆç®€æ´ç‰ˆï¼‰ ====== */
  const SIZE = 6;
  const board = document.getElementById('board');
  const overlay = document.getElementById('overlay');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const newBtn = document.getElementById('newBtn');

  let grid = [], score = 0, best = +localStorage.getItem('best6x6') || 0, won = false;
  bestEl.textContent = best;

  // ç¦æ­¢é¡µé¢åœ¨è§¦æ‘¸æ»‘åŠ¨æ—¶æ»šåŠ¨ï¼ˆé˜²æ­¢ç§»åŠ¨æ—¶é¡µé¢æ»šåŠ¨ï¼‰
  // æ³¨æ„ï¼šæˆ‘ä»¬åªé˜»æ­¢ board å†…çš„ touchmoveï¼ˆè€Œä¸æ˜¯å…¨å±€ï¼‰ï¼Œä»¥å°½é‡ä¿æŒå…¶ä»–ç³»ç»Ÿæ‰‹åŠ¿
  board.addEventListener('touchmove', e => e.preventDefault(), { passive:false });

  function init(){
    grid = Array(SIZE*SIZE).fill(0);
    score = 0; won = false;
    overlay.style.display = 'none';
    board.innerHTML = '';
    // background cells
    for(let i=0;i<SIZE*SIZE;i++){
      const c = document.createElement('div');
      c.className = 'cell';
      board.appendChild(c);
    }
    addTile(); addTile();
    render();
  }

  function addTile(){
    const empty = grid.map((v,i)=>v===0?i:null).filter(v=>v!==null);
    if(!empty.length) return;
    const idx = empty[Math.floor(Math.random()*empty.length)];
    grid[idx] = Math.random()<0.1?4:2;
  }

  function move(dir){
    let moved = false;
    const at=(r,c)=>grid[r*SIZE+c];
    const set=(r,c,v)=>grid[r*SIZE+c]=v;
    const combine = (list)=>{
      const arr=list.filter(v=>v);
      for(let i=0;i<arr.length-1;i++){
        if(arr[i]===arr[i+1]){
          arr[i]*=2; score+=arr[i]; arr.splice(i+1,1);
          if(arr[i]===2048 && !won){ won=true; setTimeout(win,120); }
        }
      }
      while(arr.length<SIZE)arr.push(0);
      return arr;
    };
    for(let i=0;i<SIZE;i++){
      let line=[];
      for(let j=0;j<SIZE;j++) line.push(dir==='left'||dir==='right'?at(i,j):at(j,i));
      if(dir==='right'||dir==='down') line.reverse();
      const newLine = combine(line.slice());
      if(dir==='right'||dir==='down') newLine.reverse();
      for(let j=0;j<SIZE;j++){
        const old = dir==='left'||dir==='right'?at(i,j):at(j,i);
        const nv = newLine[j];
        if(old !== nv) moved = true;
        if(dir==='left'||dir==='right') set(i,j,nv); else set(j,i,nv);
      }
    }
    if(moved){ addTile(); render(); if(!grid.includes(0) && !canMove()) setTimeout(lose,120); }
  }

  function canMove(){
    for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
      const v = grid[r*SIZE+c];
      if(r+1<SIZE && grid[(r+1)*SIZE+c]===v) return true;
      if(c+1<SIZE && grid[r*SIZE+c+1]===v) return true;
    }
    return false;
  }

  function render(){
    scoreEl.textContent = score;
    if(score>best){ best=score; localStorage.setItem('best6x6', best); }
    bestEl.textContent = best;
    // remove old tiles then add current
    document.querySelectorAll('.tile').forEach(t => t.remove());
    const tileSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tile-size')) || 84;
    const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 12;
    grid.forEach((v,i) => {
      if(!v) return;
      const t = document.createElement('div');
      t.className = 'tile v' + v;
      t.textContent = v;
      const r = Math.floor(i/SIZE), c = i%SIZE;
      t.style.width = tileSize + 'px';
      t.style.height = tileSize + 'px';
      // left/top: gap + index*(tile+gap)  (match CSS background cells)
      t.style.left = (c*(tileSize+gap) + gap) + 'px';
      t.style.top = (r*(tileSize+gap) + gap) + 'px';
      board.appendChild(t);
    });
  }

  function win(){
    overlay.style.display = 'flex';
    overlay.innerHTML = `<div class="modal"><h3>ğŸ‰ ä½ è¾¾åˆ°äº† 2048ï¼</h3>
      <div style="color:var(--muted);margin:10px 0">æ­å–œï¼è¦ç»§ç»­æŒ‘æˆ˜è¿˜æ˜¯é‡æ–°å¼€å§‹ï¼Ÿ</div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn" id="contBtn">ç»§ç»­</button>
        <button class="btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
      </div>
    </div>`;
    document.getElementById('contBtn').addEventListener('click', ()=> overlay.style.display='none');
    document.getElementById('restartBtn').addEventListener('click', ()=> { overlay.style.display='none'; init(); });
  }

  function lose(){
    overlay.style.display = 'flex';
    overlay.innerHTML = `<div class="modal"><h3>ğŸ’€ æ¸¸æˆç»“æŸ</h3>
      <div style="margin-top:8px"><button class="btn" id="againBtn">å†è¯•ä¸€æ¬¡</button></div></div>`;
    document.getElementById('againBtn').addEventListener('click', ()=> { overlay.style.display='none'; init(); });
  }

  // keyboard input
  window.addEventListener('keydown', e => {
    const map = { ArrowUp:'up', ArrowDown:'down', ArrowLeft:'left', ArrowRight:'right' };
    if(map[e.key]){ e.preventDefault(); move(map[e.key]); }
  });

  // touch swipe on board
  let touchStart = null;
  board.addEventListener('touchstart', e => {
    if(e.touches.length===1) touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }, { passive:true });
  board.addEventListener('touchend', e => {
    if(!touchStart) return;
    const end = e.changedTouches[0];
    const dx = end.clientX - touchStart.x;
    const dy = end.clientY - touchStart.y;
    const absX = Math.abs(dx), absY = Math.abs(dy);
    if(Math.max(absX, absY) > 20){
      if(absX > absY) move(dx > 0 ? 'right' : 'left');
      else move(dy > 0 ? 'down' : 'up');
    }
    touchStart = null;
  });

  newBtn.addEventListener('click', () => init());

  init();

  /* ====== è‡ªå®šä¹‰å…‰æ ‡é€»è¾‘ ====== */
  const cursor = document.getElementById('customCursor');
  const html = document.documentElement;

  // feature detection: if device is coarse pointer (touch), disable custom cursor
  function updateCursorMode(){
    const isCoarse = window.matchMedia('(hover: none), (pointer: coarse)').matches;
    if(isCoarse){
      html.classList.remove('no-cursor');
      html.classList.add('cursor-disabled');
    } else {
      html.classList.add('no-cursor'); // hide native
      html.classList.remove('cursor-disabled');
    }
  }
  updateCursorMode();
  // listen for changes (e.g., when connecting a mouse to tablet)
  const media = window.matchMedia('(hover: none), (pointer: coarse)');
  if(media.addEventListener) media.addEventListener('change', updateCursorMode);
  else if(media.addListener) media.addListener(updateCursorMode);

  // Ensure custom cursor visible and properly styled
  cursor.style.width = getComputedStyle(document.documentElement).getPropertyValue('--cursor-default-size') || '28px';
  cursor.style.height = cursor.style.width;
  cursor.style.borderRadius = '50%';

  // Smooth follow: track latest mouse and apply position with small requestAnimationFrame
  let mouseX = 0, mouseY = 0;
  let targetX = 0, targetY = 0;
  let rafId = null;
  window.addEventListener('mousemove', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
    // if custom cursor disabled (touch), do nothing
    if(html.classList.contains('cursor-disabled')) return;
    // immediately move (we use a tiny lerp for smoothness)
    targetX = mouseX;
    targetY = mouseY;
    cursor.style.left = targetX + 'px';
    cursor.style.top = targetY + 'px';
  });

  // Hover behavior for buttons: make cursor square and size match button
  function enterBtn(e){
    if(html.classList.contains('cursor-disabled')) return;
    const btn = e.currentTarget;
    const rect = btn.getBoundingClientRect();
    // choose size: use max(width, height) to ensure it encloses the button; cap to --cursor-max-size
    const computedMax = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cursor-max-size')) || 88;
    const size = Math.min(Math.max(rect.width, rect.height), computedMax);
    cursor.classList.add('square');
    cursor.style.width = size + 'px';
    cursor.style.height = size + 'px';
    // keep cursor following pointer (do NOT jump to center)
    // but add a subtle scaling up effect via transform: handled by CSS transition
  }
  function leaveBtn(){
    if(html.classList.contains('cursor-disabled')) return;
    cursor.classList.remove('square');
    const defaultSize = getComputedStyle(document.documentElement).getPropertyValue('--cursor-default-size') || '28px';
    cursor.style.width = defaultSize;
    cursor.style.height = defaultSize;
  }

  // Attach listeners to existing and future buttons
  function watchButtons(){
    document.querySelectorAll('.btn').forEach(b => {
      // avoid duplicate listeners by marking
      if(b.__cursorBound) return;
      b.__cursorBound = true;
      b.addEventListener('mouseenter', enterBtn);
      b.addEventListener('mouseleave', leaveBtn);
      // keyboard focus should also show square
      b.addEventListener('focus', enterBtn);
      b.addEventListener('blur', leaveBtn);
    });
  }
  watchButtons();
  const mo = new MutationObserver(watchButtons);
  mo.observe(document.body, { childList:true, subtree:true });

  // Hide custom cursor on touchstart (some devices may trigger mousemove then touch)
  window.addEventListener('touchstart', ()=> {
    html.classList.add('cursor-disabled');
    html.classList.remove('no-cursor');
  }, {passive:true});

  // make sure cursor is hidden on pointerleave of window
  window.addEventListener('mouseleave', ()=> {
    cursor.style.opacity = '0';
  });
  window.addEventListener('mouseenter', ()=> {
    cursor.style.opacity = '1';
  });

})();
</script>
</body>
</html>